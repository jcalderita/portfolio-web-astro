---
title: "Bulk Insert"
slug: "bulk-insert-es"
date: 2025-12-31
author: "Jorge Calderita"
description: "Como hacer bulk insert con Vapor para acelerar tus inserciones de datos a base de datos."
tags: ["Swift", "Vapor"]
cover: "../images/BulkInsert.png"
publicCover: "BulkInsert.webp"
coverDescription: "Jorge metiendo en un armario un mont贸n de zapatillas a la vez."
publish: false
---
---
## Problema

En aplicaciones backend con <span class="high">Vapor</span>, cuando necesitamos insertar **grandes vol煤menes de datos** en la base de datos (migraciones iniciales, importaci贸n de cat谩logos, carga masiva desde APIs externas), usar <span class="high">.save()</span> en un bucle genera **m煤ltiples transacciones individuales**.

Esto resulta en:
- **Alta latencia**: cada insert abre/cierra conexi贸n y transaction overhead.
- **Pobre throughput**: no aprovecha las capacidades de inserci贸n masiva del motor de base de datos.
- **Riesgo de timeout**: operaciones lentas que pueden fallar en entornos con l铆mites de tiempo.

Para escenarios de importaci贸n masiva (miles o millones de registros), necesitamos una estrategia de **bulk insert** que aproveche las capacidades nativas de <span class="high">PostgreSQL</span>.

---

## Soluci贸n

Extendemos <span class="high">Database</span> con una funci贸n que ejecuta el comando <span class="high">COPY</span> de <span class="high">PostgreSQL</span>, permitiendo importar archivos <span class="high">CSV</span> directamente desde el sistema de archivos al schema de la tabla.

```swift
extension Database {
    func importCSV(
        _ model: any Model.Type,
        file: PathEnum
        ) async throws {
        let query = SQLQueryString(
            """
            COPY \"\(unsafeRaw: model.space ?? "public")\".
                 \"\(unsafeRaw: model.schema)\"
            FROM '\(unsafeRaw: file.rawValue)'
            WITH (FORMAT csv, HEADER true, DELIMITER ',',
                  QUOTE '"', ESCAPE '"', NULL '')
            """
        )

        try await self.sqlDatabase.raw(query).run()
    }
}
```

Puntos clave:
- Usa <span class="high">COPY</span> de <span class="high">PostgreSQL</span>, el m茅todo m谩s r谩pido para bulk insert desde archivos.
- El par谩metro <span class="high">model.space</span> soporta schemas personalizados (por defecto <span class="high">"public"</span>).
- <span class="high">model.schema</span> obtiene autom谩ticamente el nombre de la tabla del modelo <span class="high">Fluent</span>.
- Configuraci贸n <span class="high">CSV</span> est谩ndar: headers, delimitadores y manejo de valores nulos.
- Utiliza <span class="high">unsafeRaw</span> para interpolaci贸n directa en la query SQL.

---

## Resultado

Ejemplo de uso en una migraci贸n o endpoint de importaci贸n:

```swift
private func importRegions() async throws {
    try await db.importCSV(
        RegionModel.self,
        file: .LocationFile("regions", .csv)
    )
}
```

Beneficios de esta aproximaci贸n:

-  **Performance extremo**: <span class="high">COPY</span> es hasta **10-100x m谩s r谩pido** que inserts individuales.
-  **Transacci贸n at贸mica**: toda la importaci贸n ocurre en una sola operaci贸n, garantizando consistencia.
-  **Eficiencia de recursos**: minimiza el uso de memoria y conexiones de base de datos.
-  **Integraci贸n nativa**: aprovecha capacidades optimizadas del motor <span class="high">PostgreSQL</span>.
-  **Escalabilidad**: permite importar millones de registros sin degradaci贸n significativa.

---

## Notas

Esta implementaci贸n utiliza <span class="high">COPY ... FROM</span> con archivos del sistema. Actualmente existe una **issue abierta en Vapor** para implementar soporte nativo de <span class="high">COPY ... FROM STDIN</span>, que permitir铆a realizar bulk inserts directamente desde memoria sin necesidad de archivos intermedios.

Estoy vigilando esta issue de manera activa para integrar esta funcionalidad cuando est茅 disponible, lo que proporcionar谩 una API a煤n m谩s flexible y eficiente para operaciones de importaci贸n masiva.

---
