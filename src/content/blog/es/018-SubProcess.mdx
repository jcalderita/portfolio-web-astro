---
title: "Subprocess"
slug: "sub-process-es"
date: 2025-12-17
author: "Jorge Calderita"
description: "Cambiando el uso de process por Subprocess, la nueva libreria Subprocess es un paquete multiplataforma para lanzar procesos en Swift."
tags: ["Swift", "Vapor"]
cover: "../images/Subprocess.png"
publicCover: "Subprocess.webp"
coverDescription: ""
publish: true
---
---
## Problema

Al trabajar con procesos externos en aplicaciones <span class="high">Swift</span>, la clase tradicional <span class="high">Process</span> presenta varias limitaciones importantes:

- **Gesti√≥n manual de recursos**: Requiere configuraci√≥n expl√≠cita de URLs ejecutables, argumentos y manejo de salidas
- **Falta de soporte async/await**: Utiliza m√©todos s√≠ncronos que bloquean el hilo de ejecuci√≥n
- **Manejo complejo de errores**: Dificulta la captura y procesamiento de errores del proceso hijo
- **Configuraci√≥n verbosa**: Cada ejecuci√≥n requiere m√∫ltiples l√≠neas de configuraci√≥n repetitiva

En el c√≥digo anterior, necesitaba ejecutar <span class="high">Ghostscript</span> para convertir archivos PDF a im√°genes PNG, pero la implementaci√≥n con <span class="high">Process</span> resulta extensa y poco elegante.

```swift
func _PDFToImages(
    _ fileName: PathEnum
) async throws {
    let process = Process()

    process.executableURL = URL(
        fileURLWithPath: "/opt/homebrew/bin/gs"
    )

    process.arguments = [
        "-dNOPAUSE", "-dBATCH",
        "-dQUIET", "-sDEVICE=png16m",
        "-r300",
        "-sOutputFile=\(fileName.rawValue)-%d.png",
        fileName.rawValue.appending(".pdf"),
    ]

    try process.run()
    process.waitUntilExit()
}
```

---

## Soluci√≥n

La nueva librer√≠a <span class="high">Subprocess</span> de Apple proporciona una API moderna y robusta para la ejecuci√≥n de procesos en <span class="high">Swift</span>. Esta librer√≠a **multiplataforma** ofrece soporte nativo para <span class="high">async/await</span> y gesti√≥n autom√°tica de recursos.

**Caracter√≠sticas principales:**

‚úÖ **API nativa async/await** para operaciones no bloqueantes.<br />
‚úÖ **Gesti√≥n autom√°tica de recursos** y limpieza de procesos.<br />
‚úÖ **Control granular de salidas** (stdout, stderr).<br />
‚úÖ **Verificaci√≥n de estado de terminaci√≥n** integrada.<br />
‚úÖ **Sintaxis concisa y expresiva.**  

La implementaci√≥n modernizada utiliza la funci√≥n <span class="high">run</span> de <span class="high">Subprocess</span>:

```swift
func _PDFToImages(
    _ fileName: PathEnum
) async throws {
    let result = try await run(
        .path(.init("/opt/homebrew/bin/gs")),
        arguments: [
            "-dNOPAUSE", "-dBATCH",
            "-dQUIET", "-sDEVICE=png16m",
            "-r300",
            "-sOutputFile=\(fileName.rawValue)-%d.png",
            fileName.rawValue.appending(".pdf"),
        ],
        output: .discarded,
        error: .string(limit: .max)
    )

    try guardAndLogError(
        result.terminationStatus == .exited(0),
        message: result.standardError,
        status: .internalServerError
    )
}
```

**Par√°metros clave:**
- <span class="high">.path</span>: Especifica el ejecutable de forma directa
- <span class="high">output: .discarded</span>: Descarta la salida est√°ndar ya que no necesitamos procesarla
- <span class="high">error: .string(limit: .max)</span>: Captura errores como string para logging
- <span class="high">result.terminationStatus</span>: Verifica que el proceso termin√≥ exitosamente

---

## Resultado

La migraci√≥n a <span class="high">Subprocess</span> transforma el c√≥digo de gesti√≥n de procesos en una soluci√≥n **m√°s limpia, segura y eficiente**:

**Beneficios obtenidos:**

üöÄ **Rendimiento mejorado** con operaciones as√≠ncronas reales.<br />
üîí **Mejor manejo de errores** con captura integrada de stderr.<br />
üìù **C√≥digo m√°s legible** con menos configuraci√≥n manual.<br />
‚ö° **Integraci√≥n perfecta** con el ecosistema moderno de Swift concurrency.<br />

La nueva implementaci√≥n no solo reduce la complejidad sino que tambi√©n **mejora la robustez** del sistema al proporcionar mejor visibilidad de errores y un manejo m√°s elegante de la ejecuci√≥n as√≠ncrona en aplicaciones <span class="high">Vapor</span>.

---

## Nota sobre DYLD_LIBRARY_PATH

En versiones anteriores de <span class="high">Swift</span>, exist√≠a un problema conocido con la variable de entorno <span class="high">DYLD_LIBRARY_PATH</span> al ejecutar procesos externos. Debido a las restricciones de **System Integrity Protection (SIP)** de macOS, esta variable era eliminada autom√°ticamente al lanzar subprocesos, lo que causaba errores de "Library not loaded" en ciertos casos.

La soluci√≥n temporal requer√≠a configurar manualmente las rutas de las librer√≠as usando <span class="high">install_name_tool</span> con <span class="high">@rpath</span>, o bien establecer la variable <span class="high">DYLD_LIBRARY_PATH</span> en su lugar.

**¬°Buenas noticias!** üéâ Este problema ha sido resuelto en las versiones m√°s recientes de <span class="high">Swift</span>. La librer√≠a <span class="high">Subprocess</span> maneja correctamente las variables de entorno del sistema, incluida <span class="high">DYLD_LIBRARY_PATH</span>, sin necesidad de configuraciones adicionales.

---
