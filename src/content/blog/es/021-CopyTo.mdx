---
title: "Copy To"
slug: "copy-to-es"
date: 2026-01-07
author: "Jorge Calderita"
description: "Como hacer exportaci贸n de tus datos de la base de datos."
tags: ["Swift", "Vapor"]
cover: "../images/CopyTo.png"
publicCover: "CopyTo.webp"
coverDescription: "Muchas zapatillas cayendose encima de Jorge al abrir el armario."
publish: false
---
---
## Problema

En aplicaciones backend con <span class="high">Vapor</span>, a menudo necesitamos **exportar grandes vol煤menes de datos** desde la base de datos a archivos para diferentes prop贸sitos: backups, an谩lisis offline, integraci贸n con sistemas externos, o auditor铆as de datos.

Usar consultas tradicionales con <span class="high">Fluent</span> para luego serializar los resultados manualmente presenta varios inconvenientes:
- **Alto consumo de memoria**: cargar miles de registros en memoria para procesarlos uno a uno.
- **Procesamiento lento**: serializaci贸n manual a <span class="high">CSV</span> requiere iterar y formatear cada registro.
- **Falta de optimizaci贸n**: no aprovecha las capacidades nativas de exportaci贸n del motor de base de datos.
- **Complejidad innecesaria**: gesti贸n manual de formatos, escapado de caracteres y manejo de valores nulos.

Para escenarios de exportaci贸n masiva, necesitamos una estrategia que aproveche las capacidades nativas de <span class="high">PostgreSQL</span> para generar archivos de forma eficiente.

---

## Soluci贸n

Extendemos <span class="high">Database</span> con una funci贸n que ejecuta el comando <span class="high">COPY ... TO</span> de <span class="high">PostgreSQL</span>, permitiendo exportar datos directamente desde el schema de la tabla a archivos <span class="high">CSV</span> en el sistema de archivos.

```swift
extension Database {
    func exportCSV(
        _ model: any Model.Type,
        file: PathEnum)
        async throws {
        let query = SQLQueryString(
            """
            COPY \"\(unsafeRaw: model.space ?? "public")\".
            \"\(unsafeRaw: model.schema)\"
            TO '\(unsafeRaw: file.rawValue)'
            WITH (FORMAT csv, HEADER true, DELIMITER ',',
            QUOTE '"', ESCAPE '"', NULL '')
            """
        )

        try await self.sqlDatabase
            .raw(query).run()
    }
}
```

Puntos clave:
- Usa <span class="high">COPY ... TO</span> de <span class="high">PostgreSQL</span>, el m茅todo m谩s eficiente para exportaci贸n masiva.
- El par谩metro <span class="high">model.space</span> soporta schemas personalizados (por defecto <span class="high">"public"</span>).
- <span class="high">model.schema</span> obtiene autom谩ticamente el nombre de la tabla del modelo <span class="high">Fluent</span>.
- Configuraci贸n <span class="high">CSV</span> est谩ndar: headers incluidos, delimitadores y manejo correcto de valores nulos.
- Utiliza <span class="high">unsafeRaw</span> para interpolaci贸n directa en la query SQL.

---

## Resultado

```swift
func exportRegions() async throws {
    try await db.exportCSV(
        LocationRegionModel.self, 
        file: file
    )
}
```

Beneficios de esta aproximaci贸n:

 **Performance 贸ptimo**: <span class="high">COPY ... TO</span> es mucho m谩s r谩pido que serializaci贸n manual.<br />
 **Eficiencia de recursos**: <span class="high">PostgreSQL</span> escribe directamente al archivo sin cargar datos en memoria de la aplicaci贸n.<br />
 **Formato consistente**: el motor de base de datos garantiza un <span class="high">CSV</span> v谩lido con escapado correcto.<br />
 **Integraci贸n nativa**: aprovecha capacidades optimizadas del motor <span class="high">PostgreSQL</span>.<br />
 **Escalabilidad**: permite exportar millones de registros sin impacto en el rendimiento de la aplicaci贸n.

Esta soluci贸n es el complemento perfecto para <span class="high">importCSV</span>, formando un par de funciones que permite **movimiento bidireccional de datos** entre <span class="high">PostgreSQL</span> y el sistema de archivos de forma eficiente y confiable.

---
